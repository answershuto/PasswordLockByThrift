C51 COMPILER V9.00   MAIN                                                                  05/25/2015 22:25:35 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //********************************************************************************************************
             -************************//
   2          //************************************光照度语音播报系统**************************************************
             -***********************//
   3          //************************************作者   曹阳*********************************************************
             -************************//
   4          //************************************时间   2014/7/1*****************************************************
             -************************//
   5          //********************************************************************************************************
             -************************//
   6          #include <reg52.h>
   7          #include <intrins.h>
   8          #include "gglj.h"
   9          #include "sound.h"
  10          #include "ISD1700.H"
  11                  
  12          #define uchar unsigned char
  13          #define uint  unsigned int
  14          
  15          sbit ISD_SS=P2^7;
  16          sbit ISD_MISO=P2^3;
  17          sbit ISD_MOSI=P2^5;
  18          sbit ISD_SCLK=P2^6;
  19          
  20          uchar buf;
  21          
  22          int flag=0;
  23          
  24          
  25          #define delayNOP(); {_nop_();_nop_();_nop_();_nop_();};
  26          uchar IRDIS[2];
  27          uchar IRCOM[4];
  28          
  29          
  30          /*********函数声明**************/
  31          extern void  spi_pu (void);
  32          extern void  comm_sate(void);
  33          extern void  spi_stop (void);
  34          extern void  spi_fwd (void);
  35          extern void  spi_play(void);
  36          extern void  isd1700_7byte_comm(uchar comm_par, uint star_addr, uint end_addr);
  37          void  init(void);
  38          void  PlaySoundTick(uchar  number);
  39          void  LEDShow(void);
  40          void  delay_isd(uint time);
  41          void GetSound(uchar soundtick);
  42          
  43          
  44          extern uchar get8adz(); 
  45          
  46          
  47          
  48          static void mydelay(uint z)
  49          {
  50   1           uint x,y;
C51 COMPILER V9.00   MAIN                                                                  05/25/2015 22:25:35 PAGE 2   

  51   1               for(x=z;x>0;x--)
  52   1                  for(y=110;y>0;y--);
  53   1      
  54   1      }
  55          /*******************************************************************/
  56          /*                                                                 */
  57          /*  延时函数                                                       */
  58          /*                                                                 */
  59          /*******************************************************************/
  60          void delay(int ms)
  61          {
  62   1          while(ms--)
  63   1              {
  64   2            uchar i;
  65   2                for(i=0;i<250;i++)  
  66   2                 {
  67   3                  _nop_();                       
  68   3                      _nop_();
  69   3                      _nop_();
  70   3                      _nop_();
  71   3                 }
  72   2              }
  73   1      }               
  74          
  75          /*********************************************************/
  76          /*                                                                                                               */
  77          /* 主程序                                                                                */
  78          /*                                                       */
  79          /*********************************************************/
  80          main()
  81          {
  82   1              uchar i;
  83   1      
  84   1              SCON=0x50;           //设定串口工作方式
  85   1          PCON=0x00;           //波特率不倍增
  86   1                              
  87   1          TMOD=0x20;           //定时器1工作于8位自动重载模式, 用于产生波特率
  88   1          EA=1;
  89   1          ES = 1;              //允许串口中断
  90   1          TL1=0xfd;
  91   1          TH1=0xfd;             //波特率9600
  92   1          TR1=1;
  93   1      
  94   1      
  95   1              delay(10);                 //延时
  96   1              init();                         //器件初始化          
  97   1              GetSound(0);
  98   1              spi_play();
  99   1              for(i=0;i<8;i++)
 100   1              {
 101   2                      delay(1000); 
 102   2              }
 103   1              flag=0;
 104   1      
 105   1      
 106   1              while(1)
 107   1              {
 108   2              
 109   2                      if(1 == flag) //解锁成功
 110   2                      {
 111   3                              GetSound(1);
 112   3                              spi_play();
C51 COMPILER V9.00   MAIN                                                                  05/25/2015 22:25:35 PAGE 3   

 113   3                              delay(1000); 
 114   3                              delay(1000); 
 115   3                              flag=0;
 116   3      
 117   3                      }
 118   2                      else if(2 == flag)//报警
 119   2                      {
 120   3                              GetSound(2);
 121   3                              spi_play();     
 122   3                              for(i=0;i<3;i++)
 123   3                              {
 124   4                                      delay(1000); 
 125   4                              }       
 126   3                      }
 127   2                              
 128   2              }
 129   1      }
 130          
 131          
 132          
 133          /*********************************************************/
 134          /*                                                                                                               */
 135          /* 延时x*0.14ms子程序                                                                    */
 136          /*                                                       */
 137          /*********************************************************/
 138          
 139          void delay0(uchar x)    //x*0.14MS
 140          {
 141   1        uchar i;
 142   1        while(x--)
 143   1       {
 144   2        for (i = 0; i<13; i++) {}
 145   2       }
 146   1      }
 147          
 148          void  init(void)
 149          {           
 150   1              spi_pu();       
 151   1      }
 152          
 153          
 154          
 155          void delay_isd(uint time)
 156          {
 157   1              while(time--!=0);
 158   1      }
 159          
 160          /**************获取指定语音段地址并播放，用户可根据实际需要进行增减******************/
 161          /**************对应的语音段地址在SOUND.H文件里，具体地址从录音软件中读取*************/
 162          
 163          void GetSound(uchar soundtick)
 164          {
 165   1              ISD_SS=0;
 166   1              switch(soundtick)
 167   1              {  
 168   2                      case 0:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_0A, sound_0B); }break;
 169   2                      case 1:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_1A, sound_1B); }break;
 170   2                  case 2:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_2A, sound_2B); }break;
 171   2                  case 3:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_3A, sound_3B); }break;
 172   2                  case 4:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_4A, sound_4B); }break;
 173   2                  case 5:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_5A, sound_5B); }break;
 174   2                  case 6:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_6A, sound_6B); }break;
C51 COMPILER V9.00   MAIN                                                                  05/25/2015 22:25:35 PAGE 4   

 175   2                  case 7:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_7A, sound_7B); }break;
 176   2                  case 8:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_8A, sound_8B); }break;
 177   2                  case 9:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_9A, sound_9B); }break;
 178   2                  case 10:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_10A, sound_10B); }break;
 179   2                  case 11:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_11A, sound_11B); }break;
 180   2                      case 12:{ isd1700_7byte_comm(ISD1700_SET_PLAY|ISD_LED, sound_12A, sound_12B); }break;
 181   2                  default: break;
 182   2           }
 183   1              ISD_SS=1;
 184   1      }
 185          
 186          /**********播放指定语音段************/
 187          void PlaySoundTick(uchar  number)
 188          {
 189   1                spi_stop ();
 190   1                delay_isd(30000);
 191   1            GetSound(number);
 192   1      }
 193          
 194          /*********************************************************
 195          
 196            串行中断服务函数
 197          
 198          *********************************************************/
 199          void  serial() interrupt 4 
 200          {
 201   1         ES = 0;                //关闭串行中断
 202   1         RI = 0;                //清除串行接受标志位
 203   1         buf = SBUF;            //从串口缓冲区取得数据
 204   1         flag=1;
 205   1        switch(buf)
 206   1         {
 207   2            case 0x31:  P1&=0xfe;;break;  //接受到1，第一个LED亮         
 208   2            case 0x32:  P1&=0xfd;break;  //接受到2，第二个LED亮        
 209   2            case 0x33:  P1&=0xfb;break;  //接受到3，第三个LED亮        
 210   2            case 0x34:  P1&=0xf7;break;  //接受到4，第四个LED亮       
 211   2            case 0x35:  P1&=0xef;break;  //接受到5，第五个LED亮            
 212   2            case 0x36:  P1&=0xdf;break;  //接受到6，第六个LED亮                   
 213   2            case 0x37:  P1&=0xbf;break;  //接受到7，第七个LED亮
 214   2                case 0x38:  P1&=0x7f;break;  //接受到8，第八个LED亮
 215   2                case 0x39:  flag=2;break;
 216   2                default:    flag=1;break;       
 217   2         }
 218   1         ES = 1;    //允许串口中断
 219   1      }
 220          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    561    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
